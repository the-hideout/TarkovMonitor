name: ci

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  ci:
    runs-on: windows-latest
    env:
      App_Packages_Directory: AppPackages
      SigningCertificate: TarkovMonitor.pfx
      Solution_Path: TarkovMonitor.sln
      Wpf_Project_Path: TarkovMonitor\TarkovMonitor.csproj
      Wap_Project_Directory: TarkovMonitor.Package

    steps:
      - uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # pin@v3
        with:
          fetch-depth: 0 # avoid shallow clone so nbgv can do its work.

      # Use Nerdbank.GitVersioning to set version variables: https://github.com/AArnott/nbgv
      - name: nbgv setup
        uses: dotnet/nbgv@4fab64b2438d2ff46a296d4e66b0b8f21072c42d # pin@master
        id: nbgv

      - name: install .NET core
        uses: actions/setup-dotnet@3447fd6a9f9e57506b15f895c5b76d3b197dc7c2 # pin@v3
        with:
          dotnet-version: "6.0.x"
          # cache: true # this is broken for some reason

      - name: setup MSBuild.exe
        uses: microsoft/setup-msbuild@1ff57057b5cfdc39105cd07a01d78e9b0ea0c14c # pin@v1.3.1

      - name: install dependencies
        run: msbuild $env:Solution_Path /t:Restore /p:Configuration=$env:Configuration /p:RuntimeIdentifier=$env:RuntimeIdentifier
        env:
          Configuration: Debug
          RuntimeIdentifier: win-x64

      - name: setup pfx
        run: |
          $pfx_cert_byte = [System.Convert]::FromBase64String("${{ secrets.base64_encoded_pfx }}")
          $currentDirectory = Get-Location
          $certificatePath = Join-Path -Path $currentDirectory -ChildPath $env:Wap_Project_Directory -AdditionalChildPath $env:SigningCertificate
          [IO.File]::WriteAllBytes("$certificatePath", $pfx_cert_byte)

      # Build the Windows Application Packaging project
      - name: build
        run: msbuild $env:Solution_Path /p:Platform=$env:TargetPlatform /p:Configuration=$env:Configuration /p:UapAppxPackageBuildMode=$env:BuildMode /p:AppxBundle=$env:AppxBundle /p:PackageCertificateKeyFile=$env:SigningCertificate
        env:
          AppxBundle: Never
          BuildMode: SideloadOnly
          Configuration: Debug
          TargetPlatform: Any CPU

      - name: remove pfx
        run: Remove-Item -path $env:Wap_Project_Directory\$env:SigningCertificate

      # Upload the MSIX package: https://github.com/marketplace/actions/upload-artifact
      - name: Upload build artifacts
        uses: actions/upload-artifact@0b7f8abb1508181956e8e162db84b466c27e18ce # pin@v3.1.2
        with:
          name: MSIX Package
          path: ${{ env.Wap_Project_Directory }}\${{ env.App_Packages_Directory }}
